<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>vntyper-online</title>
  <!-- Include Aioli from BioWasm CDN -->
  <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 900px; /* Increased width for better layout */
      margin: auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .file-input {
      margin-bottom: 20px;
    }
    .file-input label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .file-input input[type="file"] {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .region-select {
      margin-bottom: 20px;
    }
    .region-select label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .region-select select {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #output {
      margin-top: 30px;
      white-space: pre-wrap;
      background-color: #f4f4f4;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .error {
      color: red;
      margin-top: 10px;
      font-weight: bold;
    }
    .success {
      color: green;
      margin-top: 10px;
      font-weight: bold;
    }
    a.download-link {
      display: block;
      margin-top: 10px;
      color: #007bff;
      text-decoration: none;
    }
    a.download-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>vntyper-online</h2>

    <!-- File Input Container -->
    <div class="file-input">
      <label for="bamFiles">Select BAM and BAI Files:</label>
      <input id="bamFiles" type="file" accept=".bam,.bai" multiple />
      <small>Select corresponding BAM and BAI files. Each BAM file should have a matching BAI file (e.g., test.bam and test.bam.bai or test.bai).</small>
    </div>

    <!-- Region Select Dropdown -->
    <div class="region-select">
      <label for="region">Select Region:</label>
      <select id="region">
        <option value="" disabled selected>Select a region</option>
        <option value="chr1:155158000-155163000">MUC1 Locus (hg19): chr1:155158000-155163000</option>
        <option value="chr1:155184000-155194000" selected>MUC1 Locus (hg38): chr1:155184000-155194000</option>
      </select>
    </div>

    <button id="extractBtn">Extract Region</button>

    <div id="output"></div>
    <div id="error" class="error"></div>
  </div>

  <script type="module">
    async function initializeAioli() {
      try {
        console.log("Initializing Aioli with Samtools...");
        const CLI = await new Aioli(["samtools/1.10"]);
        console.log("Aioli initialized.");
        console.log("CLI object:", CLI);
        console.log("CLI.fs:", CLI.fs);

        if (!CLI.fs) {
          throw new Error("Failed to initialize the virtual filesystem (CLI.fs is undefined).");
        }

        return CLI;
      } catch (err) {
        console.error("Error initializing Aioli:", err);
        document.getElementById("error").textContent = "Failed to initialize the processing environment.";
        throw err;
      }
    }

    async function extractRegion(CLI) {
      // Clear previous outputs
      document.getElementById("output").innerHTML = "";
      document.getElementById("error").textContent = "";

      const fileInputs = document.getElementById("bamFiles");
      const selectedFiles = Array.from(fileInputs.files);
      const region = document.getElementById("region").value;

      console.log("Extract Region Function Triggered");
      console.log("Selected Files:", selectedFiles);
      console.log("Selected Region:", region);

      // Input Validation
      if (selectedFiles.length === 0) {
        document.getElementById("error").textContent = "Please select at least one BAM file and its corresponding BAI file.";
        console.warn("File selection error: No files selected.");
        return;
      }

      if (!region) {
        document.getElementById("error").textContent = "Please select a region.";
        console.warn("Region selection error: No region selected.");
        return;
      }

      // Organize files into BAM and BAI
      const bamFiles = selectedFiles.filter(file => file.name.endsWith(".bam"));
      const baiFiles = selectedFiles.filter(file => file.name.endsWith(".bai"));

      console.log("BAM Files:", bamFiles);
      console.log("BAI Files:", baiFiles);

      if (bamFiles.length === 0) {
        document.getElementById("error").textContent = "No BAM files selected.";
        console.warn("File selection error: No BAM files selected.");
        return;
      }

      // Match BAM files with their corresponding BAI files
      const matchedPairs = bamFiles.map(bam => {
        const baseName = bam.name.replace(/\.bam$/, '');
        const correspondingBai = baiFiles.find(bai => bai.name === `${baseName}.bai` || bai.name === `${baseName}.bam.bai`);
        return { bam, bai: correspondingBai };
      });

      // Check for unmatched BAM files
      const unmatched = matchedPairs.filter(pair => !pair.bai);
      if (unmatched.length > 0) {
        const unmatchedNames = unmatched.map(pair => pair.bam.name).join(', ');
        document.getElementById("error").textContent = `Corresponding BAI file not found for: ${unmatchedNames}. Please ensure each BAM file has a matching BAI file (e.g., test.bam.bai or test.bai).`;
        console.warn("BAI file missing for some BAM files:", unmatched);
        return;
      }

      // Update UI to indicate processing
      const extractBtn = document.getElementById("extractBtn");
      extractBtn.disabled = true;
      extractBtn.textContent = "Processing...";

      try {
        // Mount all BAM and BAI files
        console.log("Mounting BAM and BAI files...");
        const filesToMount = [];
        matchedPairs.forEach(pair => {
          filesToMount.push(pair.bam);
          filesToMount.push(pair.bai);
        });
        const paths = await CLI.mount(filesToMount);
        console.log("Mounted Paths:", paths);

        // Process each BAM and BAI pair
        for (const pair of matchedPairs) {
          const bamPath = paths.find(p => p.endsWith(pair.bam.name));
          const baiPath = paths.find(p => p.endsWith(pair.bai.name));

          console.log(`Processing BAM: ${bamPath}, BAI: ${baiPath}`);

          // Extract region using samtools view
          const outputPath = `/subset_${pair.bam.name}`;
          const command = "samtools";
          const args = ["view", "-b", bamPath, region, "-o", outputPath];
          console.log("Executing Command:", command, args);

          const result = await CLI.exec(command, args);
          console.log("Samtools View Output:", result);

          // Check if subset BAM was created and has content
          const subsetStats = await CLI.fs.stat(outputPath);
          console.log(`${outputPath} Stats:`, subsetStats);

          if (!subsetStats || subsetStats.size === 0) {
            throw new Error(`Subset BAM file ${outputPath} was not created or is empty. No reads found in the specified region.`);
          }

          // Read the subset BAM file as Uint8Array
          const subsetBam = await CLI.fs.readFile(outputPath);
          console.log(`${outputPath} length:`, subsetBam.length);

          // Create Blob from Uint8Array
          const subsetBlob = new Blob([subsetBam], { type: 'application/octet-stream' });
          console.log(`${outputPath} Blob size:`, subsetBlob.size);

          if (subsetBlob.size === 0) {
            throw new Error(`Failed to create Blob from subset BAM file ${outputPath}.`);
          }

          // Create an Object URL from the Blob
          const downloadUrl = URL.createObjectURL(subsetBlob);
          console.log("Download URL:", downloadUrl);

          // Create and append the download link
          const downloadLink = document.createElement("a");
          downloadLink.href = downloadUrl;
          downloadLink.download = `subset_${pair.bam.name}`;
          downloadLink.textContent = `Download subset_${pair.bam.name}`;
          downloadLink.classList.add("download-link");

          document.getElementById("output").appendChild(downloadLink);

          console.log("Download link created successfully.");
        }

        // Optional: Revoke the Object URLs after some time to free memory
        setTimeout(() => {
          document.querySelectorAll('#output a').forEach(link => {
            URL.revokeObjectURL(link.href);
            console.log(`Object URL revoked for ${link.download}`);
          });
        }, 60000); // Revoke after 60 seconds

      } catch (err) {
        console.error("Error during extraction:", err);
        document.getElementById("error").textContent = `Error: ${err.message}`;
      } finally {
        // Reset the button
        extractBtn.disabled = false;
        extractBtn.textContent = "Extract Region";
      }
    }

    async function main() {
      const CLI = await initializeAioli();
      if (!CLI) return;

      document.getElementById("extractBtn").addEventListener("click", () => extractRegion(CLI));
    }

    main();
  </script>
</body>
</html>
